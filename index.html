<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>æ˜Ÿå…‰å¯¹å†³ - æ€§åˆ«/å¹´é¾„/é¢†åŸŸåˆ†åŒº</title>
<style>
/* â€”â€” æ ·å¼ â€”â€” */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'PingFang SC','Helvetica Neue',Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333;overflow-x:hidden}
.container{max-width:1200px;margin:0 auto;padding:20px}
.header{text-align:center;margin-bottom:40px;color:white;animation:fadeInDown 1s ease-out}
.header h1{font-size:3.2em;margin-bottom:12px;background:linear-gradient(45deg,#fff,#f0f0f0);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-shadow:3px 3px 6px rgba(0,0,0,.4)}
.header p{font-size:1.1em;opacity:.95;text-shadow:1px 1px 3px rgba(0,0,0,.3)}
.nav{display:flex;justify-content:center;gap:16px;margin-bottom:20px;flex-wrap:wrap;animation:fadeInUp 1s ease-out .3s both}
.nav-btn{background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.3);color:white;padding:12px 22px;border-radius:30px;cursor:pointer;transition:all .4s cubic-bezier(.175,.885,.32,1.275);backdrop-filter:blur(15px);font-size:1em;font-weight:600;position:relative;overflow:hidden}
.nav-btn:hover,.nav-btn.active{background:rgba(255,255,255,.25);transform:translateY(-3px) scale(1.05);box-shadow:0 12px 35px rgba(0,0,0,.3);border-color:rgba(255,255,255,.5)}
.filters{display:flex;justify-content:center;gap:12px;flex-wrap:wrap;margin-bottom:24px;animation:slideInUp .8s ease-out .5s both}
.filter-card{background:rgba(255,255,255,.95);border-radius:14px;padding:12px 16px;box-shadow:0 12px 35px rgba(0,0,0,.15);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.2)}
.filter-card label{font-weight:700;margin-right:8px;color:#333}
.filter-card select{padding:6px 10px;border-radius:10px;border:2px solid #ddd;font-size:14px;background:white;cursor:pointer}
.hidden{display:none}
.comparison-section,.leaderboard,.cp-section,.battle-section{background:rgba(255,255,255,.95);border-radius:20px;padding:28px;margin-bottom:22px;box-shadow:0 25px 80px rgba(0,0,0,.15);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.2)}
.comparison-section h2,.leaderboard h2,.cp-section h2,.battle-section h2{text-align:center;font-size:2.1em;margin-bottom:20px;background:linear-gradient(45deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.comparison-container{display:flex;justify-content:space-between;align-items:center;gap:24px;max-width:980px;margin:0 auto}
.star-card{flex:1;text-align:center;padding:22px 18px;border-radius:18px;background:linear-gradient(145deg,#f8f9fa,#fff);box-shadow:0 15px 40px rgba(0,0,0,.1);position:relative;border:2px solid transparent}
.champion-card{border-color:#ffd700;box-shadow:0 15px 40px rgba(255,215,0,.3)}
.challenger-card{border-color:#ff6b6b;box-shadow:0 15px 40px rgba(255,107,107,.3)}
.star-photo{width:160px;height:220px;border-radius:15px;margin:0 auto 12px;background-size:cover;background-position:center;background-repeat:no-repeat;position:relative}
.photo-upload-overlay{position:absolute;top:5px;right:5px;background:rgba(0,0,0,.7);color:white;border:none;width:30px;height:30px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}
.star-name{font-size:1.3em;font-weight:bold;margin-bottom:6px}
.star-quote{color:#667eea;font-style:italic;font-size:.95em;margin-bottom:8px;min-height:20px;cursor:pointer}
.wins-count{color:#667eea;font-weight:600;margin-bottom:10px;font-size:.92em}
.vote-btn{background:linear-gradient(45deg,#667eea,#764ba2);color:white;border:none;padding:12px 26px;border-radius:26px;cursor:pointer;font-size:1em;font-weight:bold}
.vs-divider{font-size:2.2em;font-weight:bold;background:linear-gradient(45deg,#ff6b6b,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.badge{font-size:12px;padding:2px 8px;border-radius:999px;background:#eef}
.post-actions{margin-top:10px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
.post-link-btn{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid #667eea;color:#667eea;text-decoration:none;font-size:12px;background:#fff}
.post-link-btn:hover{background:#eef}
.battle-news{background:linear-gradient(45deg,#f8f9fa,#e9ecef);border-radius:12px;padding:18px;margin-bottom:14px;border-left:5px solid #667eea}
.ranks-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;max-width:980px;margin:0 auto}
.rank-card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
.rank-card h3{margin:0 0 8px 0;font-size:16px;color:#555}
.rank-card ol{margin:0;padding-left:18px}
.rank-card li{margin:4px 0}
@keyframes fadeInDown{from{opacity:0;transform:translateY(-30px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideInUp{from{opacity:0;transform:translateY(50px)}to{opacity:1;transform:translateY(0)}}
@media (max-width:768px){.container{padding:15px}.header h1{font-size:2.2em}.comparison-container{flex-direction:column;gap:16px}.vs-divider{transform:rotate(90deg);margin:12px 0}.ranks-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ”¥ æ˜Ÿå…‰å¯¹å†³ ğŸ”¥</h1>
    <p>æ“‚å°æ— é™å¯¹æ‰“ï¼ˆElo è®¡åˆ†ï¼‰ï¼›æŠ•ç¨¿è·³è½¬æŠ•ç¥¨é¡µï¼›æ¦œå•è‡ªåŠ¨ Top10ã€‚</p>
  </div>

  <div class="nav">
    <button class="nav-btn active" onclick="showSection(event,'arena')">ğŸŸï¸ æ˜æ˜Ÿæ“‚å°</button>
    <button class="nav-btn" onclick="showSection(event,'cp')">ğŸ’• CPå¤§ä½œæˆ˜</button>
    <button class="nav-btn" onclick="showSection(event,'ranking')">ğŸ‘‘ ç‹è€…æ¦œå•</button>
    <button class="nav-btn" onclick="showSection(event,'battle')">ğŸ’¥ æˆ˜å†µæ’­æŠ¥</button>
  </div>

  <!-- è¿‡æ»¤å™¨ä»…ä½œç”¨äºæ˜æ˜Ÿæ“‚å°ä¸æ˜æ˜Ÿæ¦œå• -->
  <div class="filters">
    <div class="filter-card"><label>æ€§åˆ«ï¼š</label>
      <select id="genderFilter" onchange="applyFilters()"><option value="all">å…¨éƒ¨</option><option value="male">ç”·</option><option value="female">å¥³</option></select>
    </div>
    <div class="filter-card"><label>å¹´é¾„æ®µï¼š</label>
      <select id="ageFilter" onchange="applyFilters()">
        <option value="all">å…¨éƒ¨</option>
        <option value="gen2000">00åï¼ˆâ‰¤24ï¼‰</option>
        <option value="gen1990">90åï¼ˆ25â€“34ï¼‰</option>
        <option value="gen1980">80åï¼ˆ35â€“44ï¼‰</option>
        <option value="gen1970">70å+ï¼ˆâ‰¥45ï¼‰</option>
      </select>
    </div>
    <div class="filter-card"><label>é¢†åŸŸï¼š</label>
      <select id="categoryFilter" onchange="applyFilters()">
        <option value="all">å…¨éƒ¨</option><option value="actor">å½±è§†æ¼”å‘˜</option><option value="singer">æ­Œæ‰‹</option>
      </select>
    </div>
  </div>

  <!-- æ˜æ˜Ÿæ“‚å° -->
  <div id="arenaSection" class="comparison-section">
    <h2>ğŸŸï¸ æ˜æ˜Ÿæ“‚å°</h2>
    <div class="comparison-container">
      <div class="star-card champion-card" id="leftCard">
        <div class="star-photo" id="arenaLeftPhoto">
          <!-- æ”¹ä¸ºè·³è½¬æŠ•ç¨¿é¡µï¼ˆä¸å†è°ƒç”¨æœªå®šä¹‰çš„ openPhotoModalï¼‰ -->
          <button class="photo-upload-overlay"
                  onclick="event.stopPropagation(); location.href='submissions.html?entity=star&side=left&type=photo'"
                  title="ä¸Šä¼ ç…§ç‰‡">ğŸ“·</button>
        </div>
        <div class="star-name" id="arenaLeftName"></div>
        <div class="star-quote" id="arenaLeftQuote" title="ç‚¹å‡»ç¼–è¾‘ä¸ªæ€§ç®€ä»‹">ç‚¹å‡»æ·»åŠ ä¸ªæ€§ç®€ä»‹...</div>
        <div class="wins-count" id="leftWins">è¿èƒœ: 0åœº</div>
        <button class="vote-btn" id="leftVoteBtn">å·¦ä¾§èƒœ</button>
        <div class="post-actions">
          <a id="leftPhotoPost" class="post-link-btn" href="#">ğŸ–¼ å›¾ç‰‡æŠ•ç¨¿</a>
          <a id="leftQuotePost" class="post-link-btn" href="#">âœï¸ ç®€ä»‹æŠ•ç¨¿</a>
        </div>
      </div>
      <div class="vs-divider">âš¡VSâš¡</div>
      <div class="star-card challenger-card" id="rightCard">
        <div class="star-photo" id="arenaRightPhoto">
          <button class="photo-upload-overlay"
                  onclick="event.stopPropagation(); location.href='submissions.html?entity=star&side=right&type=photo'"
                  title="ä¸Šä¼ ç…§ç‰‡">ğŸ“·</button>
        </div>
        <div class="star-name" id="arenaRightName"></div>
        <div class="star-quote" id="arenaRightQuote" title="ç‚¹å‡»ç¼–è¾‘ä¸ªæ€§ç®€ä»‹">ç‚¹å‡»æ·»åŠ ä¸ªæ€§ç®€ä»‹...</div>
        <div class="wins-count" id="rightWins">è¿èƒœ: 0åœº</div>
        <button class="vote-btn" id="rightVoteBtn">å³ä¾§èƒœ</button>
        <div class="post-actions">
          <a id="rightPhotoPost" class="post-link-btn" href="#">ğŸ–¼ å›¾ç‰‡æŠ•ç¨¿</a>
          <a id="rightQuotePost" class="post-link-btn" href="#">âœï¸ ç®€ä»‹æŠ•ç¨¿</a>
        </div>
      </div>
    </div>
  </div>

  <!-- CP å¤§ä½œæˆ˜ï¼ˆæ“‚å° + æŠ•ç¨¿æŒ‰é’®ï¼‰ -->
  <div id="cpSection" class="cp-section hidden">
    <h2>ğŸ’• CPå¤§ä½œæˆ˜ï¼ˆæ“‚å°ï¼‰</h2>
    <div class="comparison-container">
      <div class="star-card champion-card" id="cpLeftCard">
        <div class="star-photo" id="cpLeftPhoto"></div>
        <div class="star-name" id="cpLeftName"></div>
        <div class="star-quote" id="cpLeftQuote">â€”</div>
        <div class="wins-count" id="cpLeftWins">è¿èƒœ: 0åœº</div>
        <button class="vote-btn" id="cpLeftVoteBtn">å·¦ä¾§èƒœ</button>
        <div class="post-actions">
          <a id="cpLeftPhotoPost" class="post-link-btn" href="#">ğŸ–¼ å›¾ç‰‡æŠ•ç¨¿</a>
          <a id="cpLeftQuotePost" class="post-link-btn" href="#">âœï¸ ç®€ä»‹æŠ•ç¨¿</a>
        </div>
      </div>
      <div class="vs-divider">âš¡VSâš¡</div>
      <div class="star-card challenger-card" id="cpRightCard">
        <div class="star-photo" id="cpRightPhoto"></div>
        <div class="star-name" id="cpRightName"></div>
        <div class="star-quote" id="cpRightQuote">â€”</div>
        <div class="wins-count" id="cpRightWins">è¿èƒœ: 0åœº</div>
        <button class="vote-btn" id="cpRightVoteBtn">å³ä¾§èƒœ</button>
        <div class="post-actions">
          <a id="cpRightPhotoPost" class="post-link-btn" href="#">ğŸ–¼ å›¾ç‰‡æŠ•ç¨¿</a>
          <a id="cpRightQuotePost" class="post-link-btn" href="#">âœï¸ ç®€ä»‹æŠ•ç¨¿</a>
        </div>
      </div>
    </div>
  </div>

  <!-- æ¦œå• -->
  <div id="rankingSection" class="leaderboard hidden">
    <h2>ğŸ‘‘ ç‹è€…æ¦œå•</h2>
    <div id="rankingWrap" class="ranks-grid"></div>
  </div>

  <!-- æˆ˜å†µæ’­æŠ¥ -->
  <div id="battleSection" class="battle-section hidden">
    <h2>ğŸ’¥ æˆ˜å†µæ’­æŠ¥</h2>
    <div class="battle-news" id="battleFeed">è¿˜æ²¡æœ‰æˆ˜å†µï¼Œå¿«å¼€å§‹å¯¹æ‰“ï¼</div>
  </div>
</div>

<script>
/* ========== å·¥å…·ä¸çŠ¶æ€ ========== */
const $ = s => document.querySelector(s);
const uid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);
const now = () => Date.now();
const cap = s => s.charAt(0).toUpperCase()+s.slice(1);
const posterOf = name => `https://placehold.co/320x440/png?text=${encodeURIComponent(name||'')}`;
const STORAGE_KEY='stargame_v10';

const K_FACTOR=32;

/* åˆå§‹æ˜æ˜Ÿä¸æ•°æ® */
const starsRaw=[
  {name:'æ˜“çƒŠåƒçº',gender:'male',age:23,category:'actor',score:1250,wins:0},
  {name:'ç‹ä¿Šå‡¯',gender:'male',age:24,category:'singer',score:1180,wins:0},
  {name:'ç‹æº',gender:'male',age:23,category:'singer',score:1150,wins:0},
  {name:'å¼ å­æ«',gender:'female',age:22,category:'actor',score:1120,wins:0},
  {name:'æ¬§é˜³å¨œå¨œ',gender:'female',age:23,category:'variety',score:980,wins:0},
  {name:'å…³æ™“å½¤',gender:'female',age:26,category:'actor',score:1050,wins:0},
  {name:'è‚–æˆ˜',gender:'male',age:32,category:'actor',score:1320,wins:0},
  {name:'ç‹ä¸€åš',gender:'male',age:26,category:'actor',score:1280,wins:0},
  {name:'è¿ªä¸½çƒ­å·´',gender:'female',age:31,category:'actor',score:1200,wins:0},
  {name:'æç°',gender:'male',age:32,category:'actor',score:1050,wins:0},
  {name:'å¤åŠ›å¨œæ‰',gender:'female',age:31,category:'actor',score:980,wins:0},
  {name:'é‚“ç´«æ£‹',gender:'female',age:32,category:'singer',score:1160,wins:0},
  {name:'åæ™¨å®‡',gender:'male',age:33,category:'singer',score:1090,wins:0},
  {name:'å‘¨æ·±',gender:'male',age:31,category:'singer',score:1070,wins:0},
  {name:'æ¯›ä¸æ˜“',gender:'male',age:30,category:'singer',score:1020,wins:0},
  {name:'é¹¿æ™—',gender:'male',age:34,category:'actor',score:1100,wins:0},
  {name:'èµµä¸½é¢–',gender:'female',age:36,category:'actor',score:1180,wins:0},
  {name:'æ¨å¹‚',gender:'female',age:37,category:'actor',score:1150,wins:0},
  {name:'æœ±ä¸€é¾™',gender:'male',age:35,category:'actor',score:1100,wins:0},
  {name:'åˆ˜äº¦è²',gender:'female',age:36,category:'actor',score:1220,wins:0},
  {name:'è–›ä¹‹è°¦',gender:'male',age:40,category:'singer',score:1080,wins:0},
  {name:'è°¢å¨œ',gender:'female',age:42,category:'variety',score:1150,wins:0},
  {name:'ä½•ç‚…',gender:'male',age:49,category:'variety',score:1300,wins:0},
  {name:'æ²ˆè…¾',gender:'male',age:44,category:'actor',score:1350,wins:0},
  {name:'é»„æ¸¤',gender:'male',age:49,category:'actor',score:1280,wins:0},
  {name:'å­™ä¿ª',gender:'female',age:41,category:'actor',score:1200,wins:0},
];

/* CP æ•°æ® */
const popularCPs = [
  {id:'cp_1',name:"è‚–æˆ˜ Ã— ç‹ä¸€åš",star1:"è‚–æˆ˜",star2:"ç‹ä¸€åš",source:"ã€Šé™ˆæƒ…ä»¤ã€‹",score:15880,type:"è€½ç¾CP",wins:0},
  {id:'cp_2',name:"æ¨ç´« Ã— è‚–æˆ˜",star1:"è‚–æˆ˜",star2:"æ¨ç´«",source:"ã€Šä½™ç”Ÿè¯·å¤šæŒ‡æ•™ã€‹",score:12450,type:"è§å¹•CP",wins:0},
  {id:'cp_3',name:"èµµä¸½é¢– Ã— ç‹ä¸€åš",star1:"ç‹ä¸€åš",star2:"èµµä¸½é¢–",source:"ã€Šæœ‰ç¿¡ã€‹",score:11200,type:"è§å¹•CP",wins:0},
  {id:'cp_4',name:"è¿ªä¸½çƒ­å·´ Ã— æ¨æ´‹",star1:"æ¨æ´‹",star2:"è¿ªä¸½çƒ­å·´",source:"ã€Šä½ æ˜¯æˆ‘çš„è£è€€ã€‹",score:10800,type:"è§å¹•CP",wins:0},
  {id:'cp_5',name:"å¤åŠ›å¨œæ‰ Ã— æ˜“çƒŠåƒçº",star1:"æ˜“çƒŠåƒçº",star2:"å¤åŠ›å¨œæ‰",source:"ã€Šé•¿å®‰åäºŒæ—¶è¾°ã€‹",score:9900,type:"è§å¹•CP",wins:0},
  {id:'cp_6',name:"åˆ˜äº¦è² Ã— æœ±ä¸€é¾™",star1:"æœ±ä¸€é¾™",star2:"åˆ˜äº¦è²",source:"ã€Šæ¢¦åå½•ã€‹",score:9600,type:"è§å¹•CP",wins:0},
  {id:'cp_7',name:"å…³æ™“å½¤ Ã— é¹¿æ™—",star1:"é¹¿æ™—",star2:"å…³æ™“å½¤",source:"ç°å®æƒ…ä¾£",score:8500,type:"çœŸå®CP",wins:0},
  {id:'cp_8',name:"æ¨å¹‚ Ã— æç°",star1:"æç°",star2:"æ¨å¹‚",source:"è”æƒ³",score:8200,type:"æ¢¦å¹»CP",wins:0},
  {id:'cp_9',name:"å¼ å­æ« Ã— æ˜“çƒŠåƒçº",star1:"æ˜“çƒŠåƒçº",star2:"å¼ å­æ«",source:"ã€Šå°‘å¹´çš„ä½ ã€‹",score:7800,type:"è§å¹•CP",wins:0},
  {id:'cp_10',name:"åæ™¨å®‡ Ã— é‚“ç´«æ£‹",star1:"åæ™¨å®‡",star2:"é‚“ç´«æ£‹",source:"éŸ³ä¹åˆä½œ",score:7200,type:"éŸ³ä¹CP",wins:0},
];

/* â€”â€” å¹´é¾„æ®µå·¥å…· â€”â€” */
const ageGroup = a => (a<=24?'gen2000':a<=34?'gen1990':a<=44?'gen1980':'gen1970');

/* â€”â€” çŠ¶æ€ â€”â€” */
const DEFAULT_STATE={
  left:{id:'left',name:'æ˜“çƒŠåƒçº',defaultPhotoUrl:posterOf('æ˜“çƒŠåƒçº'),defaultQuote:'å‡ºæ‰‹å³å·…å³°',currentPhotoUrl:null,currentQuote:null,wins:0,candidates:[]},
  right:{id:'right',name:'ç‹ä¸€åš',defaultPhotoUrl:posterOf('ç‹ä¸€åš'),defaultQuote:'ä»ä¸è¨€å¼ƒ',currentPhotoUrl:null,currentQuote:null,wins:0,candidates:[]},
  cpList: popularCPs.map(cp=>({
    id:cp.id,name:cp.name,
    defaultPhotoUrl:posterOf(cp.name),defaultQuote:cp.type||'å¤©ä½œä¹‹åˆ',
    currentPhotoUrl:posterOf(cp.name),currentQuote:cp.type||'å¤©ä½œä¹‹åˆ',
    source:cp.source,type:cp.type,score:cp.score,wins:0,candidates:[]
  })),
  arena:{queue:[],ptr:0},
  cpArena:{queue:[],ptr:0,leftId:null,rightId:null},
  ratings:Object.fromEntries(starsRaw.map(s=>[s.name,s.score])),
  cpRatings:Object.fromEntries(popularCPs.map(cp=>[cp.name, cp.score]))
};
function loadState(){try{const raw=localStorage.getItem(STORAGE_KEY);if(raw){const st=JSON.parse(raw);return {...DEFAULT_STATE,...st};}}catch{}const init=JSON.parse(JSON.stringify(DEFAULT_STATE));init.left.currentPhotoUrl=init.left.defaultPhotoUrl;init.left.currentQuote=init.left.defaultQuote;init.right.currentPhotoUrl=init.right.defaultPhotoUrl;init.right.currentQuote=init.right.defaultQuote;return init;}
function saveState(){localStorage.setItem(STORAGE_KEY,JSON.stringify(state));}
let state=loadState();

/* â€”â€” Eloï¼ˆæ˜æ˜Ÿï¼‰ â€”â€” */
const getRating=n=>state.ratings?.[n] ?? 1200;
const setRating=(n,v)=>{state.ratings[n]=Math.round(v);};
function eloUpdate(win,lose){
  const Ra=getRating(win), Rb=getRating(lose);
  const Ea=1/(1+10**((Rb-Ra)/400));
  const Eb=1-Ea;
  const Ra2=Ra+K_FACTOR*(1-Ea);
  const Rb2=Rb+K_FACTOR*(0-Eb);
  setRating(win,Ra2); setRating(lose,Rb2); saveState();
  return {winDelta:Math.round(Ra2-Ra),loseDelta:Math.round(Rb2-Rb)};
}

/* â€”â€” Eloï¼ˆCP ç‹¬ç«‹ï¼‰ â€”â€” */
const getCPRating=n=>state.cpRatings?.[n] ?? 1200;
const setCPRating=(n,v)=>{state.cpRatings[n]=Math.round(v);};
function eloUpdateCP(win,lose){
  const Ra=getCPRating(win), Rb=getCPRating(lose);
  const Ea=1/(1+10**((Rb-Ra)/400));
  const Eb=1-Ea;
  const Ra2=Ra+K_FACTOR*(1-Ea);
  const Rb2=Rb+K_FACTOR*(0-Eb);
  setCPRating(win,Ra2); setCPRating(lose,Rb2); saveState();
  return {winDelta:Math.round(Ra2-Ra),loseDelta:Math.round(Rb2-Rb)};
}

/* â€”â€” è¿‡æ»¤/é˜Ÿåˆ—ï¼ˆæ˜æ˜Ÿï¼‰ â€”â€” */
function getFilteredStarQueue(){
  const g=$('#genderFilter').value,a=$('#ageFilter').value,c=$('#categoryFilter').value;
  return starsRaw
    .filter(s=>g==='all'||s.gender===g)
    .filter(s=>a==='all'||ageGroup(s.age)===a)
    .filter(s=>c==='all'||s.category===c)
    .sort((x,y)=>getRating(y.name)-getRating(x.name));
}
function rebuildArenaQueue(){state.arena.queue=getFilteredStarQueue();state.arena.ptr=0;saveState();}
function nextChallenger(exclude=[]){
  const q=state.arena.queue.length?state.arena.queue:getFilteredStarQueue();
  if(!q.length) return null;
  for(let i=0;i<q.length;i++){
    const idx=(state.arena.ptr+i)%q.length; const cand=q[idx];
    if(!exclude.includes(cand.name)){ state.arena.ptr=(idx+1)%q.length; saveState(); return cand; }
  }
  return null;
}

/* â€”â€” é˜Ÿåˆ—ï¼ˆCPï¼‰ â€”â€” */
function rebuildCPQueue(){
  state.cpArena.queue = [...state.cpList].sort((a,b)=>getCPRating(b.name)-getCPRating(a.name));
  state.cpArena.ptr=0; saveState();
}
function nextCPChallenger(excludeIds=[]){
  const q=state.cpArena.queue.length?state.cpArena.queue:[...state.cpList];
  if(!q.length) return null;
  for(let i=0;i<q.length;i++){
    const idx=(state.cpArena.ptr+i)%q.length; const cand=q[idx];
    if(!excludeIds.includes(cand.id)){ state.cpArena.ptr=(idx+1)%q.length; saveState(); return cand; }
  }
  return null;
}

/* â€”â€” æ¸²æŸ“ï¼šæ˜æ˜Ÿå¡ + æŠ•ç¨¿è·³è½¬ â€”â€” */
function setCard(side,data){
  const p=$(`#arena${cap(side)}Photo`), n=$(`#arena${cap(side)}Name`), q=$(`#arena${cap(side)}Quote`), w= side==='left' ? $('#leftWins') : $('#rightWins');
  if(p) p.style.backgroundImage=`url('${data.currentPhotoUrl||data.defaultPhotoUrl}')`;
  if(n) n.textContent=data.name||'';
  if(q){ q.textContent=data.currentQuote||''; q.onclick=(ev)=>{ev.stopPropagation();const val=prompt('è¾“å…¥ä¸€å¥è¯ç®€ä»‹ï¼ˆä¸­æ–‡â‰¤10å­—ï¼‰ï¼š', data.currentQuote||data.defaultQuote||''); if(val==null) return; const clean=val.replace(/\s+/g,''); if([...clean].length>10||!clean){alert('ä¸è¶…è¿‡10ä¸ªä¸­æ–‡å­—ç¬¦');return;} const cand={id:uid(),type:'quote',data:clean,votes:0,createdAt:now(),entity:'star',side}; data.candidates.unshift(cand); saveState();};}
  if(w) w.textContent=`è¿èƒœ: ${data.wins||0}åœº`;
  const photoBtn = document.getElementById(side==='left'?'leftPhotoPost':'rightPhotoPost');
  const quoteBtn = document.getElementById(side==='left'?'leftQuotePost':'rightQuotePost');
  if(photoBtn) photoBtn.href = `submissions.html?entity=star&side=${side}&type=photo`;
  if(quoteBtn) quoteBtn.href = `submissions.html?entity=star&side=${side}&type=quote`;
}

/* â€”â€” æ¸²æŸ“ï¼šCP å¡ + æŠ•ç¨¿è·³è½¬ â€”â€” */
function setCPCard(side, cpObj){
  const p=$(`#cp${cap(side)}Photo`), n=$(`#cp${cap(side)}Name`), q=$(`#cp${cap(side)}Quote`), w=$(`#cp${cap(side)}Wins`);
  if(p) p.style.backgroundImage=`url('${cpObj.currentPhotoUrl||cpObj.defaultPhotoUrl}')`;
  if(n) n.textContent=cpObj.name||'';
  if(q) q.textContent=cpObj.currentQuote||cpObj.type||'â€”';
  if(w) w.textContent=`è¿èƒœ: ${cpObj.wins||0}åœº`;
  const photoBtn = document.getElementById(side==='left'?'cpLeftPhotoPost':'cpRightPhotoPost');
  const quoteBtn = document.getElementById(side==='left'?'cpLeftQuotePost':'cpRightQuotePost');
  if(photoBtn) photoBtn.href = `submissions.html?entity=cp&cpId=${encodeURIComponent(cpObj.id)}&type=photo`;
  if(quoteBtn) quoteBtn.href = `submissions.html?entity=cp&cpId=${encodeURIComponent(cpObj.id)}&type=quote`;
}

/* â€”â€” è½½å…¥æ˜æ˜Ÿ/CPåˆ°å·¦å³ä½ â€”â€” */
function loadStarIntoSide(side, starObj){
  const slot=state[side];
  slot.name=starObj.name;
  slot.defaultPhotoUrl=posterOf(starObj.name);
  if(!slot.currentPhotoUrl) slot.currentPhotoUrl=slot.defaultPhotoUrl;
  if(!slot.currentQuote) slot.currentQuote='ä¸ªæ€§åè¶³';
  slot.wins=0; saveState(); setCard(side,slot);
}
function loadCPIntoSide(side, cpObj){
  state.cpArena[side+'Id']=cpObj.id;
  if(!cpObj.currentPhotoUrl) cpObj.currentPhotoUrl = cpObj.defaultPhotoUrl || posterOf(cpObj.name);
  if(!cpObj.currentQuote)    cpObj.currentQuote    = cpObj.type || 'å¤©ä½œä¹‹åˆ';
  cpObj.wins = cpObj.wins || 0;
  saveState(); setCPCard(side, cpObj);
}

/* â€”â€” æ˜æ˜Ÿå¯¹æˆ˜æµç¨‹ â€”â€” */
function handleArenaWin(winnerSide){
  const loserSide=winnerSide==='left'?'right':'left';
  const wName=state[winnerSide].name, lName=state[loserSide].name;
  const {winDelta,loseDelta}=eloUpdate(wName,lName);
  state[winnerSide].wins=(state[winnerSide].wins||0)+1;
  const exclude=[state.left.name,state.right.name];
  let challenger=nextChallenger(exclude);
  if(!challenger){rebuildArenaQueue(); challenger=nextChallenger(exclude);}
  if(challenger) loadStarIntoSide(loserSide,challenger);
  saveState(); setCard('left',state.left); setCard('right',state.right);
  $('#battleFeed').textContent=`ã€æ˜æ˜Ÿã€‘${wName} èƒœï¼ˆ+${winDelta}ï¼‰ï¼Œ${lName}ï¼ˆ${loseDelta}ï¼‰ç¦»åœºï¼Œæ–°çš„æŒ‘æˆ˜è€…ï¼š${state[loserSide].name}`;
  renderRanking();
}

/* â€”â€” CP å¯¹æˆ˜æµç¨‹ï¼ˆç‹¬ç«‹ Elo ä¸é˜Ÿåˆ—ï¼‰ â€”â€” */
function getCPById(id){ return state.cpList.find(c=>c.id===id); }
function handleCPWin(winnerSide){
  const loserSide = winnerSide==='left'?'right':'left';
  const w = getCPById(state.cpArena[winnerSide+'Id']);
  const l = getCPById(state.cpArena[loserSide+'Id']);
  if(!w || !l) return;
  const {winDelta,loseDelta}=eloUpdateCP(w.name,l.name);
  w.wins = (w.wins||0)+1;

  // æ‰¾æ–°çš„æŒ‘æˆ˜è€…ï¼ˆé¿å…ä¸å½“å‰ä¸¤ä½é‡å¤ï¼‰
  const exclude=[state.cpArena.leftId,state.cpArena.rightId];
  let challenger = nextCPChallenger(exclude);
  if(!challenger){ rebuildCPQueue(); challenger = nextCPChallenger(exclude); }
  if(challenger){ loadCPIntoSide(loserSide, challenger); }

  saveState(); setCPCard('left', getCPById(state.cpArena.leftId)); setCPCard('right', getCPById(state.cpArena.rightId));
  $('#battleFeed').textContent=`ã€CPã€‘${w.name} èƒœï¼ˆ+${winDelta}ï¼‰ï¼Œ${l.name}ï¼ˆ${loseDelta}ï¼‰ç¦»åœºï¼Œæ–°çš„æŒ‘æˆ˜è€…ï¼š${getCPById(state.cpArena[loserSide+'Id']).name}`;
  renderRanking();
}

/* ç»‘å®šæŒ‰é’® */
$('#leftVoteBtn').onclick=(e)=>{e.stopPropagation();handleArenaWin('left');};
$('#rightVoteBtn').onclick=(e)=>{e.stopPropagation();handleArenaWin('right');};
$('#cpLeftVoteBtn').onclick=(e)=>{e.stopPropagation();handleCPWin('left');};
$('#cpRightVoteBtn').onclick=(e)=>{e.stopPropagation();handleCPWin('right');};

/* â€”â€” æ¦œå•æ¸²æŸ“ â€”â€” */
function renderRanking(){
  const wrap = $('#rankingWrap'); if(!wrap) return;
  const gSel=$('#genderFilter').value, aSel=$('#ageFilter').value, cSel=$('#categoryFilter').value;

  const ageGroupOf = a => (a<=24?'gen2000':a<=34?'gen1990':a<=44?'gen1980':'gen1970');

  // æ„å»ºæ˜æ˜Ÿè¯„åˆ†åˆ—è¡¨ï¼ˆå¯å¸¦ç­›é€‰ï¼‰
  const stars = starsRaw
    .filter(s=>gSel==='all'||s.gender===gSel)
    .filter(s=>aSel==='all'||ageGroupOf(s.age)===aSel)
    .filter(s=>cSel==='all'||s.category===cSel)
    .map(s=>({name:s.name,score:state.ratings[s.name]??1200,gender:s.gender,age:s.age,ageGroup:ageGroupOf(s.age),category:s.category}))
    .sort((a,b)=>b.score-a.score);

  const top10 = arr => arr.slice(0,10);
  const asList = arr => arr.map((x)=>`<li>${x.name} <span style="color:#667eea;font-weight:700;">${x.score}</span></li>`).join('');

  // åˆ†æ¦œ
  const male   = stars.filter(s=>s.gender==='male');
  const female = stars.filter(s=>s.gender==='female');
  const g2000  = stars.filter(s=>s.ageGroup==='gen2000');
  const g1990  = stars.filter(s=>s.ageGroup==='gen1990');
  const g1980  = stars.filter(s=>s.ageGroup==='gen1980');
  const g1970  = stars.filter(s=>s.ageGroup==='gen1970');
  const actor  = stars.filter(s=>s.category==='actor');
  const singer = stars.filter(s=>s.category==='singer');
  const variety= stars.filter(s=>s.category==='variety');

  // CP æ¦œï¼ˆä¸å—ç­›é€‰ï¼‰
  const cpRanks = state.cpList
    .map(cp=>({name:cp.name,score:getCPRating(cp.name)}))
    .sort((a,b)=>b.score-a.score);

  wrap.innerHTML = `
    <div class="rank-card"><h3>æ€»æ¦œ Top10</h3><ol>${asList(top10(stars))}</ol></div>
    <div class="rank-card"><h3>ç”· Top10</h3><ol>${asList(top10(male))}</ol></div>
    <div class="rank-card"><h3>å¥³ Top10</h3><ol>${asList(top10(female))}</ol></div>
    <div class="rank-card"><h3>00å Top10</h3><ol>${asList(top10(g2000))}</ol></div>
    <div class="rank-card"><h3>90å Top10</h3><ol>${asList(top10(g1990))}</ol></div>
    <div class="rank-card"><h3>80å Top10</h3><ol>${asList(top10(g1980))}</ol></div>
    <div class="rank-card"><h3>70å+ Top10</h3><ol>${asList(top10(g1970))}</ol></div>
    <div class="rank-card"><h3>æ¼”å‘˜ Top10</h3><ol>${asList(top10(actor))}</ol></div>
    <div class="rank-card"><h3>æ­Œæ‰‹ Top10</h3><ol>${asList(top10(singer))}</ol></div>
    <div class="rank-card"><h3>ç»¼è‰º Top10</h3><ol>${asList(top10(variety))}</ol></div>
    <div class="rank-card" style="grid-column:1/-1"><h3>CP Top10</h3><ol>${asList(top10(cpRanks))}</ol></div>
  `;
}

/* â€”â€” è¿‡æ»¤è§¦å‘ï¼ˆåˆ·æ–°æ˜æ˜Ÿæ“‚å°ã€æ¦œå•ï¼‰ â€”â€” */
function applyFilters(){
  // æ˜æ˜Ÿæ“‚å°
  const list=getFilteredStarQueue();
  if(list.length){
    const a=list[0],b=list.find(s=>s.name!==a.name)||list[0];
    loadStarIntoSide('left',a); loadStarIntoSide('right',b);
  }
  rebuildArenaQueue();
  setCard('left',state.left); setCard('right',state.right);

  // æ¦œå•
  renderRanking();
}

/* â€”â€” Tab åˆ‡æ¢ â€”â€” */
function showSection(ev,key){
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  if(ev) ev.currentTarget.classList.add('active');
  ['arena','cp','ranking','battle'].forEach(k=>document.getElementById(k+'Section')?.classList.add('hidden'));
  document.getElementById(key+'Section')?.classList.remove('hidden');
}

/* â€”â€” åˆå§‹åŒ–ï¼šæ˜æ˜Ÿã€CP é˜Ÿåˆ—ä¸å¡ç‰‡ â€”â€” */
function initArena(){
  applyFilters(); // è®¾ç½®æ˜æ˜Ÿå·¦å³ä½ + æ¦œå•
}
function initCPArena(){
  rebuildCPQueue();
  const q = state.cpArena.queue.length ? state.cpArena.queue : state.cpList;
  const left = q[0], right = q.find(x=>x.id!==left.id) || q[0];
  loadCPIntoSide('left', left);
  loadCPIntoSide('right', right);
}

/* go */
initArena();
initCPArena();
renderRanking();
</script>
</body>
</html>
