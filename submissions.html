<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>æŠ•ç¨¿ä¸æŠ•ç¥¨ | æ˜Ÿå…‰å¯¹å†³</title>
<style>
*{box-sizing:border-box} body{font-family:'PingFang SC','Helvetica Neue',Arial,sans-serif;background:#f6f7fb;margin:0;color:#333}
.container{max-width:980px;margin:24px auto;padding:0 16px}
.header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:18px 16px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
.header h1{margin:0;font-size:1.6em}
.breadcrumb{margin-top:8px;font-size:12px;opacity:.9}
.panel{background:#fff;border-radius:14px;padding:16px;margin-top:16px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
.panel h2{margin:0 0 10px 0;font-size:1.2em}
.btn{display:inline-block;background:#667eea;color:#fff;text-decoration:none;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600}
.btn.secondary{background:#eef;color:#334;border:1px solid #ccd}
.item{display:flex;align-items:center;gap:12px;padding:10px 0;border-top:1px solid #f0f0f0}
.item img{width:70px;height:94px;object-fit:cover;border-radius:8px}
.meta{font-size:12px;color:#666}
.badge{padding:2px 8px;background:#eef;border-radius:999px;font-size:12px}
.rule{font-size:13px;line-height:1.6;color:#444}
.muted{color:#888}
input[type="file"],input[type="text"]{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px}
.hint{font-size:12px;color:#999;margin-top:6px}
@media (max-width:768px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1 id="pageTitle">æŠ•ç¨¿ä¸æŠ•ç¥¨</h1>
    <div class="breadcrumb"><a href="index.html" style="color:#fff;text-decoration:underline;">â† è¿”å›é¦–é¡µ</a></div>
  </div>

  <div class="panel">
    <h2>æŠ•ç¥¨è§„åˆ™</h2>
    <div class="rule">
      â€¢ æ¯ä¸ªè´¦å· <b>æ¯ 2 å°æ—¶</b>å¯æŠ• <b>1 ç¥¨</b>ï¼ˆå†·å´æœŸé—´ä¸èƒ½å†æ¬¡æŠ•ï¼‰<br>
      â€¢ åœ¨æœ¬é¡µå¤šä¸ªå€™é€‰ä¸­ï¼Œ<b>ä¸€æ¬¡æŠ•ç¥¨åªèƒ½é€‰ä¸€ä¸ª</b><br>
      â€¢ æŠ•ç¨¿ç¥¨æ•° <b>> 10</b> è‡ªåŠ¨æ›¿æ¢é¦–é¡µé»˜è®¤å±•ç¤ºï¼ˆå›¾ç‰‡æˆ–ç®€ä»‹ï¼‰<br>
      â€¢ ç®€ä»‹<b>é™ä¸­æ–‡ 10 å­—ä»¥å†…</b>ï¼›å†…å®¹éœ€å¥åº·åˆè§„
    </div>
    <div id="cooldownTip" class="hint"></div>
  </div>

  <div class="panel">
    <h2 id="uploadTitle">ä¸Šä¼ æŠ•ç¨¿</h2>
    <div id="uploadBox"></div>
  </div>

  <div class="panel">
    <h2>å·²æ”¶åˆ°çš„æŠ•ç¨¿</h2>
    <div id="listBox"></div>
  </div>
</div>

<script>
/* ===== ä¸ index.html å¯¹é½çš„å­˜å‚¨é”®ï¼ˆv10ï¼‰ ===== */
const STORAGE_KEY='stargame_v10';
const LAST_VOTE_AT_KEY='stargame_last_vote_at';
const VOTE_COOLDOWN_MS=2*60*60*1000;
const PROMOTE_THRESHOLD=10;

const uid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);
const now = () => Date.now();
const posterOf = name => `https://placehold.co/320x440/png?text=${encodeURIComponent(name||'')}`;

function loadState(){ try{ const raw=localStorage.getItem(STORAGE_KEY); if(raw) return JSON.parse(raw);}catch(e){} return null; }
function saveState(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }
function canVote(){ const t=+localStorage.getItem(LAST_VOTE_AT_KEY)||0; return now()-t>=VOTE_COOLDOWN_MS; }
function markVoted(){ localStorage.setItem(LAST_VOTE_AT_KEY, String(now())); }
function validateChineseQuote(s){ const clean=(s||'').replace(/\s+/g,''); const len=[...clean].length; return {ok:len>0&&len<=10,clean,len}; }
function fileToDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }

/* ===== URL å‚æ•°è§£æ =====
   entity=star|cp
   - star: side=left|right, type=photo|quote
   - cp:   cpId=cp_xxx,   type=photo|quote
*/
const params=new URLSearchParams(location.search);
const entity=(params.get('entity')||'star').toLowerCase();
const type=(params.get('type')||'photo').toLowerCase();

let state = loadState();
if(!state){
  // å…œåº•ï¼šæœ€å°å¯è¿è¡ŒçŠ¶æ€ï¼Œä¾¿äºç”¨æˆ·ç›´æ¥è®¿é—®æœ¬é¡µæµ‹è¯•
  state = {
    left:{name:'æ˜“çƒŠåƒçº',defaultPhotoUrl:posterOf('æ˜“çƒŠåƒçº'),defaultQuote:'å‡ºæ‰‹å³å·…å³°',currentPhotoUrl:posterOf('æ˜“çƒŠåƒçº'),currentQuote:'å‡ºæ‰‹å³å·…å³°',candidates:[]},
    right:{name:'ç‹ä¸€åš',defaultPhotoUrl:posterOf('ç‹ä¸€åš'),defaultQuote:'ä»ä¸è¨€å¼ƒ',currentPhotoUrl:posterOf('ç‹ä¸€åš'),currentQuote:'ä»ä¸è¨€å¼ƒ',candidates:[]},
    cpList:[{id:'cp_tmp',name:'ä¸´æ—¶CP',defaultPhotoUrl:posterOf('ä¸´æ—¶CP'),currentPhotoUrl:posterOf('ä¸´æ—¶CP'),defaultQuote:'å¤©ä½œä¹‹åˆ',currentQuote:'å¤©ä½œä¹‹åˆ',candidates:[]}]
  };
  saveState(state);
}

/* ===== é€‰æ‹©ä¸»ä½“ï¼ˆæ˜æ˜Ÿ or CPï¼‰ ===== */
let hostObj=null;
let titleName='';

if(entity==='star'){
  const side=params.get('side')==='right' ? 'right' : 'left';
  hostObj = state[side];
  if(!hostObj){ // å†—ä½™å…œåº•
    state[side]={name: side==='left'?'å·¦ä¾§æ˜æ˜Ÿ':'å³ä¾§æ˜æ˜Ÿ', defaultPhotoUrl:posterOf('æ˜æ˜Ÿ'), currentPhotoUrl:posterOf('æ˜æ˜Ÿ'), defaultQuote:'ä¸ªæ€§åè¶³', currentQuote:'ä¸ªæ€§åè¶³', candidates:[]};
    hostObj=state[side]; saveState(state);
  }
  titleName = hostObj.name || (side==='left'?'å·¦ä¾§æ˜æ˜Ÿ':'å³ä¾§æ˜æ˜Ÿ');
}else{
  const cpId=params.get('cpId');
  if(Array.isArray(state.cpList)){
    hostObj = state.cpList.find(c=>String(c.id)===String(cpId)) || state.cpList[0];
  }
  if(!hostObj){
    // è‹¥æ²¡æœ‰ cpList æˆ–æ‰¾ä¸åˆ°ï¼Œæ„é€ ä¸€ä¸ªæœ€å° CP æ¡ç›®
    hostObj = {id: cpId||'cp_tmp', name:'ä¸´æ—¶CP', defaultPhotoUrl:posterOf('ä¸´æ—¶CP'), currentPhotoUrl:posterOf('ä¸´æ—¶CP'), defaultQuote:'å¤©ä½œä¹‹åˆ', currentQuote:'å¤©ä½œä¹‹åˆ', candidates:[]};
    state.cpList = state.cpList || [];
    state.cpList.push(hostObj); saveState(state);
  }
  titleName = hostObj.name || 'CP';
}

/* ===== é¡µé¢æŠ¬å¤´ ===== */
document.getElementById('pageTitle').textContent = `${type==='photo'?'å›¾ç‰‡æŠ•ç¨¿':'ç®€ä»‹æŠ•ç¨¿'} Â· ${titleName}`;
document.getElementById('uploadTitle').textContent = `ä¸Šä¼ ${type==='photo'?'å›¾ç‰‡':'ç®€ä»‹'}ï¼ˆ${titleName}ï¼‰`;

/* ===== å†·å´æç¤º ===== */
function renderCooldownTip(){
  const el=document.getElementById('cooldownTip');
  if(canVote()){ el.textContent='ä½ ç°åœ¨å¯ä»¥æŠ•ç¥¨ âœ…'; }
  else{
    const left=+localStorage.getItem(LAST_VOTE_AT_KEY)||0;
    const remain=VOTE_COOLDOWN_MS-(now()-left);
    const m=Math.max(0,Math.ceil(remain/60000));
    el.textContent=`å†·å´ä¸­ï¼šçº¦ ${m} åˆ†é’Ÿåå¯å†æ¬¡æŠ•ç¥¨`;
  }
}
renderCooldownTip();

/* ===== ä¸Šä¼ åŒº ===== */
function renderUploadBox(){
  const box=document.getElementById('uploadBox'); box.innerHTML='';
  if(type==='photo'){
    const input=document.createElement('input'); input.type='file'; input.accept='image/*';
    const hint=document.createElement('div'); hint.className='hint'; hint.textContent='é€‰æ‹©å›¾ç‰‡åä½œä¸ºæ–°çš„å€™é€‰é¡¹æäº¤ã€‚';
    const btn=document.createElement('button'); btn.className='btn'; btn.textContent='æäº¤å›¾ç‰‡';
    btn.onclick=async()=>{
      if(!input.files || !input.files[0]){ alert('è¯·å…ˆé€‰æ‹©å›¾ç‰‡'); return; }
      const dataUrl=await fileToDataURL(input.files[0]);
      const cand={id:uid(),type:'photo',data:dataUrl,votes:0,createdAt:now(),entity};
      // è®°å½•å®šä½å­—æ®µï¼šstar ç”¨ sideï¼Œcp ç”¨ cpId
      if(entity==='star'){ cand.side=(state.left===hostObj?'left':'right'); }
      else{ cand.cpId=hostObj.id; }
      hostObj.candidates = hostObj.candidates || [];
      hostObj.candidates.unshift(cand);
      saveState(state); renderList();
      alert('ä¸Šä¼ æˆåŠŸï¼è®°å¾—ç»™å–œæ¬¢çš„æŠ•ç¨¿æŠ•ç¥¨ï½');
    };
    box.appendChild(input); box.appendChild(hint); box.appendChild(document.createElement('br')); box.appendChild(document.createElement('br')); box.appendChild(btn);
  }else{
    const input=document.createElement('input'); input.type='text'; input.placeholder='è¯·è¾“å…¥ä¸­æ–‡ç®€ä»‹ï¼ˆâ‰¤10å­—ï¼‰';
    const hint=document.createElement('div'); hint.className='hint'; hint.textContent='ä¾‹å¦‚ï¼šå‡ºæ‰‹å³å·…å³°';
    const btn=document.createElement('button'); btn.className='btn'; btn.textContent='æäº¤ç®€ä»‹';
    btn.onclick=()=>{
      const {ok,clean,len}=validateChineseQuote(input.value);
      if(!ok){ alert(`ç®€ä»‹é•¿åº¦ ${len}ï¼Œéœ€åœ¨ 1â€“10 ä¸ªä¸­æ–‡å­—ç¬¦å†…`); return; }
      const cand={id:uid(),type:'quote',data:clean,votes:0,createdAt:now(),entity};
      if(entity==='star'){ cand.side=(state.left===hostObj?'left':'right'); }
      else{ cand.cpId=hostObj.id; }
      hostObj.candidates = hostObj.candidates || [];
      hostObj.candidates.unshift(cand);
      saveState(state); renderList(); input.value='';
      alert('ä¸Šä¼ æˆåŠŸï¼è®°å¾—ç»™å–œæ¬¢çš„æŠ•ç¨¿æŠ•ç¥¨ï½');
    };
    box.appendChild(input); box.appendChild(hint); box.appendChild(document.createElement('br')); box.appendChild(document.createElement('br')); box.appendChild(btn);
  }
}
renderUploadBox();

/* ===== æŠ•ç¨¿åˆ—è¡¨ + æŠ•ç¥¨ï¼ˆ2 å°æ—¶å†·å´ / ä¸€æ¬¡åªèƒ½æŠ•ä¸€ä¸ªï¼‰ ===== */
function renderList(){
  const box=document.getElementById('listBox'); box.innerHTML='';
  const list=(hostObj.candidates||[]).filter(c=>c.type===type);
  if(!list.length){ box.innerHTML='<div class="muted">æš‚æ— æŠ•ç¨¿ï¼Œå¿«æˆä¸ºç¬¬ä¸€ä¸ªå§ï½</div>'; return; }

  list.sort((a,b)=>b.votes-a.votes);
  list.forEach(c=>{
    const row=document.createElement('div'); row.className='item';

    if(c.type==='photo'){
      const img=document.createElement('img'); img.src=c.data; row.appendChild(img);
    }else{
      const ph=document.createElement('div'); ph.className='badge'; ph.textContent='ç®€ä»‹'; row.appendChild(ph);
    }

    const col=document.createElement('div'); col.style.flex='1';
    col.innerHTML = c.type==='quote'
      ? `<div style="font-weight:700;color:#444;">â€œ${c.data}â€</div>`
      : `<div class="meta">å›¾ç‰‡æŠ•ç¨¿</div>`;
    const pv=document.createElement('div'); pv.className='meta'; pv.textContent=`ç¥¨æ•°ï¼š${c.votes}`; col.appendChild(pv);
    row.appendChild(col);

    const btn=document.createElement('button'); btn.className='btn'; btn.textContent='æŠ•ä¸€ç¥¨';
    btn.onclick=()=>{
      if(!canVote()){ alert('å†·å´ä¸­ï¼šæ¯è´¦å·æ¯ 2 å°æ—¶å¯æŠ• 1 ç¥¨'); return; }
      c.votes+=1; markVoted(); saveState(state); renderList(); renderCooldownTip();
      if(c.votes > PROMOTE_THRESHOLD){
        if(c.type==='photo'){ hostObj.currentPhotoUrl=c.data; }
        else{ hostObj.currentQuote=c.data; }
        saveState(state);
        alert('ğŸ‰ ç¥¨æ•° > 10ï¼Œå·²æ›¿æ¢é¦–é¡µé»˜è®¤å±•ç¤ºï¼');
      }
    };
    row.appendChild(btn);

    box.appendChild(row);
  });
}
renderList();
</script>
</body>
</html>
